# 全局变量系统概述与标识符规范

**版本号**: v2.2.0  
**创建时间**: 2025年3月18日  
**最后更新**: 2025年3月25日  
**文档状态**: 已定稿  
**关键词**: 全局变量, UUID, 变量标识符

## 系统概述

全局变量系统是Netsphere平台的核心基础设施，为整个系统提供统一的变量管理和访问机制。通过全局变量，各个功能模块（如NPC、工作任务、工作流等）可以将其内部数据作为变量开放给系统中的其他模块使用。

本次系统重构的主要目标是优化变量标识符的稳定性和可靠性，解决因变量来源对象（如NPC、工作任务）名称变更导致的变量引用失效问题。新的变量标识符系统采用基于UUID的格式，确保变量引用的长期稳定性，同时保持良好的用户体验。

### 主要特性

1. **UUID标识符格式**：采用`@gv_UUID_field`格式作为系统内部标识符，确保变量引用不受源对象名称变更的影响
2. **双重标识符机制**：在系统内部使用UUID标识符，同时保留人类可读的显示标识符（用于UI展示）
3. **兼容性设计**：支持旧格式标识符解析，确保系统平滑过渡
4. **高扩展性**：支持多种变量源提供者的注册与动态加载
5. **统一的变量管理**：提供统一的变量查询、创建、更新和删除接口
6. **变量解析引擎**：高效识别和替换文本中的变量引用
7. **变量事件订阅机制**：支持实时数据更新与通知（v2.2.0新增）
8. **缓存与防抖机制**：优化API调用性能，提高系统响应速度（v2.2.0增强）

### 变量类型

全局变量系统目前支持以下类型的变量：

1. **NPC变量** - 来自NPC模块的变量，如NPC的知识背景、行为原则等
2. **工作任务变量** - 来自工作任务模块的变量，如任务输入、输出等
3. **工作流变量** - 来自工作流模块的变量，如工作流状态、节点数据等
4. **自定义变量** - 用户手动创建的变量，可用于全局设置或常量定义
5. **文件变量** - 基于文件内容生成的变量

## 变量标识符技术规范

### 1. 标识符格式定义

新系统采用两种格式的变量标识符：

#### 系统标识符（内部使用）
```
@gv_{UUID}_{field}
```

- `@` - 统一前缀，标记这是一个变量引用
- `gv_` - 全局变量前缀（global variable）
- `{UUID}` - 变量的唯一标识符，通常是源对象的ID
- `_{field}` - 下划线加字段名，指定变量的具体字段

#### 显示标识符（UI展示）
```
@{sourceName}.{field}#{shortId}
```

- `@` - 统一前缀
- `{sourceName}` - 变量来源对象的名称
- `.` - 固定分隔符
- `{field}` - 字段名称
- `#` - ID分隔符
- `{shortId}` - ID的短版本（4位）

### 2. 标识符示例

| 变量类型 | 来源 | 字段 | 系统标识符 | 显示标识符 |
|---------|------|-----|-----------|------------|
| NPC | 云透 | 知识背景 | `@gv_7f3a81d2-6c8a-4b0f-b1d5-8e7f9a2c1b3d_kb` | `@云透.知识背景#7f3a` |
| 工作流 | 需求分析 | 状态 | `@gv_c5d2e8f1-9a7b-4c6d-8e3f-2a1b0c9d8e7f_status` | `@需求分析.status#c5d2` |
| 自定义 | 系统设置 | 值 | `@gv_1647932481293_value` | `@系统设置.value#1293` |

### 3. 标识符生成规则

1. **系统标识符**：
   - 对于所有类型变量，系统标识符使用IdentifierFormatterService的formatIdentifier方法生成
   - 该方法使用源对象的UUID作为核心部分，确保唯一性和稳定性
   - 格式为`@gv_{sourceId}_{field}`，其中field是变量字段名

2. **显示标识符**：
   - 使用IdentifierFormatterService的formatDisplayIdentifier方法生成
   - 针对字符型ID，取前4位作为短标识符
   - 针对数字型ID（如时间戳），取后4位作为短标识符

3. **标识符更新策略**：
   - 当源对象名称变更时，系统标识符保持不变
   - 显示标识符会更新以反映新的源对象名称
   - 这确保了引用稳定性的同时保持UI的一致性和可理解性

4. **UUID生成机制** (v2.2.0详细说明)：
   - 对于新建的自定义变量，使用RFC4122 v4标准生成随机UUID
   - 对于基于时间戳的标识符，使用timestampToUUID函数转换为UUID格式
   - 生成的UUID在数据库中确保唯一性，避免冲突

### 4. 命名规则与限制

#### 字段名称规范

**NPC类型变量字段**：
- `name` - 名称
- `description` - 描述
- `knowledge` - 知识背景
- `act` - 行动原则
- `actlv` - 活跃度

**已废弃的NPC变量字段**（不再使用）：
- `kb` - 知识背景（简化自knowledge_background）
- `ap` - 行动原则（简化自action_principles）
- `al` - 活跃度（简化自activity_level）

**工作任务类型字段**：
- `input` - 输入
- `output` - 输出
- `status` - 状态

**工作流类型字段**：
- `name` - 名称
- `description` - 描述
- `status` - 状态
- 对节点的引用使用 `node_{nodeId}_{field}` 格式

#### 源名称处理

- 源名称中的特殊字符将被替换为下划线，确保标识符的有效性
- 支持中文、英文字母、数字和下划线
- 源名称在显示标识符中保持原格式，以提升可读性

### 5. 变量引用与解析

当在提示词或其他场景中引用变量时：

1. 系统会在提交前解析所有符合`@格式`的标识符
2. 将标识符替换为实际的变量值
3. 对于未找到的变量，可保留原标识符或返回错误提示

#### 主要解析格式

1. **系统标识符**：`@gv_{UUID}_{field}`
2. **显示标识符**：`@sourceName.field#id`
3. **旧格式标识符**：`@sourceName.field`（向后兼容）

#### 变量解析优先级

服务器端变量解析器目前主要支持旧格式的`@source.field`标识符，而客户端变量解析器实现了更完整的解析能力，包括：

1. 先尝试按完整标识符精确匹配
2. 如果未找到，尝试按显示标识符匹配
3. 如果仍未找到，尝试按旧格式标识符匹配
4. 如果所有尝试都失败，则根据配置保留原始文本或替换为错误提示

#### 客户端增强功能

客户端变量解析器还提供了以下增强功能：

1. **变量缓存**：减少重复请求，提高解析性能
2. **标识符更新**：根据最新的源对象名称更新显示标识符
3. **宽松匹配模式**：提供更灵活的标识符匹配能力
4. **调试日志**：支持记录解析过程，便于问题诊断

#### v2.2.0新增解析功能

1. **部分匹配算法改进**：针对大型文本中的变量识别进行了优化
2. **变量事件订阅机制**：在变量值更新时自动刷新相关内容
3. **解析防抖动**：避免短时间内多次触发相同的解析请求
4. **手动刷新API**：允许用户在需要时强制刷新变量值

### 6. 变量数据处理 (v2.2.0新增)

1. **自定义变量列表显示优化**：
   - 来源列显示变量名称，更直观地展示数据来源
   - 名称列统一显示"值"，保持界面一致性

2. **变量标签样式优化**：
   - 移除特定字体设置，使用全局字体风格，保持UI一致性
   - 工作任务(TASK)类型变量颜色从#52C41A改为更深的#389E0D，提高可识别性
   - 优化变量标签背景色，使用更饱和的颜色增强视觉区分

3. **数据获取流程重构**：
   - 始终使用最新数据，确保变量值的实时性
   - 优化API请求合并，减少网络请求数量

## 系统优势

1. **稳定性提升**：变量引用不再依赖源对象名称，避免了因重命名导致的引用失效问题
2. **易用性保持**：通过显示标识符保留了人类可读的格式，便于开发人员和用户理解和使用
3. **高兼容性**：支持旧格式标识符，确保现有系统平滑过渡
4. **扩展性增强**：标准化的变量标识符格式，便于系统扩展和第三方集成
5. **性能优化**：引入缓存和防抖机制，提高系统响应速度
6. **实时更新**：变量事件订阅机制确保数据的实时性

## 最佳实践 (v2.2.0新增)

1. **使用系统标识符存储**：
   - 在数据存储和系统间通信中，始终使用系统标识符格式
   - 示例：`@gv_f9c17d21-a0a0-476f-973e-433e08f7be38_actlv`

2. **界面显示优化**：
   - 在UI界面中使用显示标识符，提升可读性
   - 对不同类型的变量使用不同颜色，便于区分

3. **变量解析效率**：
   - 避免频繁解析相同内容，利用缓存机制
   - 对大型文本使用批量解析而非单个解析

4. **自定义变量命名**：
   - 选择简明扼要的名称，便于在变量选择器中快速找到
   - 避免使用特殊字符和超长名称

5. **变量数据更新**：
   - 订阅变量事件，确保UI实时反映最新数据
   - 在关键操作后手动触发刷新，确保数据一致性

## 相关文档

- [变量标识符解析规范](./variable-identifier-parsing.md)
- [系统架构设计](./variable-system-architecture.md)
- [全局变量系统配置指南](./variable-system-configuration.md)
- [UI设计规范](./variable-system-ui-design.md)
- [变量源集成指南](./variable-source-integration.md)
- [迁移与最佳实践](./variable-system-migration.md)
