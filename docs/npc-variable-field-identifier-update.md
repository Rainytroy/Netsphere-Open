# NPC变量字段标识符更新说明

## 背景和问题

在当前的系统中，NPC变量使用的标识符格式是 `@gv_{npcId}`，这种格式意味着NPC的所有字段（名称、描述、知识背景、行为原则等）共享同一个标识符。这导致了两个主要问题：

1. **变量去重问题**：系统会自动去重相同标识符的变量，导致在某些情况下，只有一个NPC字段的变量被保留
2. **语义不明确**：无法从标识符直接区分是哪个字段的变量

## 解决方案

我们实现了一种更合理的标识符格式：`@gv_{npcId}_{fieldName}`，即在标识符中包含字段名。

例如：
- NPC "小明" (ID: 123abc) 的名称字段：`@gv_123abc_name`
- NPC "小明" (ID: 123abc) 的知识背景字段：`@gv_123abc_knowledge`

这种格式的优势：

1. **避免去重问题**：每个字段都有独立的标识符，不会因为标识符相同而被去重
2. **语义明确**：标识符本身就包含了字段信息，更易于理解
3. **保持数据关联**：所有字段的变量仍然通过同一个NPC ID关联，便于管理
4. **向前兼容**：修改后的解析器可以同时支持新旧两种格式的标识符

## 实现方法

1. 修改 `IdentifierFormatterService.ts` 中的 `formatIdentifier` 方法，使其生成包含字段名的标识符
2. 更新 `parseIdentifier` 方法，使其能够从新格式标识符中提取字段信息
3. 创建 `regenerate-npc-variables.ts` 脚本，用于重新生成所有NPC变量，应用新的标识符格式

## 使用方法

1. 运行 `tests/run-regenerate-npc-variables.bat` 脚本，重新生成所有NPC变量
2. 运行后，系统会：
   - 删除旧的NPC变量
   - 使用新格式重新生成NPC变量
   - 在控制台输出处理结果

## 注意事项

1. 此更新修改了NPC变量的标识符格式，但不影响显示标识符 (displayIdentifier)
2. 脚本会删除并重新创建所有NPC相关变量，请确保在执行前备份重要数据
3. 更新后，工作流中引用NPC变量的部分可能需要更新以使用新的标识符

## 常见问题

**Q: 这会影响现有的工作流吗？**  
A: 是的，如果工作流中直接引用了NPC变量的标识符，需要更新它们以使用新的标识符格式。

**Q: 更新后如何查看新的标识符？**  
A: 可以通过变量列表页面查看，或使用变量API查询。

**Q: 是否需要更新前端代码？**  
A: 前端代码使用服务端提供的标识符，无需特别修改，只需确保使用最新的变量数据。
