# 工作流模块概念设计

**版本号**: v1.0.0  
**创建时间**: 2025年3月13日  
**文档状态**: 初稿  

> 本文档是Netsphere工作流模块的概念设计，描述了工作流模块的目标、用户场景、功能需求及界面规范。
> 技术实现细节请参见姊妹文档：[工作流模块技术规范](workflow-module-technical-spec.md)
> API接口详情请参见：[工作流模块API接口规范](workflow-module-api-spec.md)
> UI组件设计请参见：[工作流模块UI组件规范](workflow-module-ui-component-spec.md)

## 目录
1. [模块概述与设计理念](#1-模块概述与设计理念)
2. [用户场景](#2-用户场景)
3. [功能需求](#3-功能需求)
4. [界面设计规范](#4-界面设计规范)
5. [卡片类型定义](#5-卡片类型定义)

## 1. 模块概述与设计理念

工作流模块是Netsphere系统中最复杂且重要的模块，旨在提供直观的可视化工具让用户设计和执行复杂的AI工作流。它通过卡片拖拽和连接的方式，使用户能轻松构建自动化流程，组合利用NPC、AI服务和系统功能。

### 1.1 核心设计理念

- **简洁直观**：以直观的可视化方式创建和管理工作流
- **高度可定制**：支持多种卡片类型和连接规则
- **稳定可靠**：确保工作流长时间运行的稳定性
- **无缝集成**：与现有NPC、变量和工作任务模块深度整合
- **可扩展性**：系统架构支持未来功能扩展

### 1.2 模块定位

工作流模块是Netsphere系统的顶层组件，它整合了其他所有基础模块，提供一站式的AI工作流自动化解决方案。其核心价值在于将分散的功能组件编排为可执行的工作流，显著提高用户工作效率。

## 2. 用户场景

### 2.1 目标用户

- **内容创作者**：构建内容生成流程
- **设计师**：创建复杂的AI辅助设计流程
- **业务分析师**：构建数据分析和报告生成流程
- **对话设计师**：创建复杂的交互对话流程

### 2.2 典型使用场景

1. **AI写作流程**：
   - 用户在起点卡输入主题
   - 工作流自动生成提纲、写作内容、校对并整合
   - 最终输出完整文章

2. **数据分析报告**：
   - 用户输入数据和分析需求
   - 工作流分步执行数据清洗、分析和可视化
   - 生成专业报告

3. **交互式内容创建**：
   - 系统引导用户回答一系列问题
   - 根据用户回答动态调整工作流路径
   - 最终输出定制化内容

## 3. 功能需求

工作流模块分为两个主要部分：工作流列表和单个工作流（包含编辑和使用两个模式）。

### 3.1 工作流列表

- **卡片式展示**：符合现有UI规范的工作流卡片列表
- **基础操作**：
  - 创建新工作流
  - 编辑已有工作流
  - 删除工作流
  - 复制工作流（复制后添加"-副本"后缀）
  - 运行工作流
- **搜索筛选**：支持按名称搜索和排序

### 3.2 工作流编辑器

- **界面布局**：
  - 顶部导航区：返回箭头、工作流名称（可编辑）、保存按钮、使用按钮、退出按钮
  - 左侧卡片选择区：流程卡标签页和工作任务卡标签页
  - 右侧画布区：用于拖放和连接卡片的主要工作区域
  
- **卡片拖放**：
  - 从左侧选择区拖动卡片到画布
  - 卡片在选择区显示已使用数量
  - 卡片在画布中可移动位置
  
- **连接管理**：
  - 卡片选中时显示四个连接点
  - 拖动连接线连接不同卡片
  - 支持连接线的创建和删除
  - 循环卡特有的Yes/No分支连接
  
- **画布交互**：
  - 支持上下左右平移（无缩放需求）
  - 支持卡片的删除和属性编辑
  - 自动记录编辑状态

### 3.3 工作流使用界面

- **用户输入区**：
  - 默认显示起点卡配置的输入框和提交按钮
  - 支持动态生成的输入组件（由工作流决定）
  - 提交后显示运行状态和停止按钮
  
- **系统输出区**：
  - 展示卡片输出内容
  - 支持Markdown格式渲染
  - 支持导出为MD和PDF格式
  - 支持生成式文本显示效果
  - 工作流完成后显示全部结果

## 4. 界面设计规范

### 4.1 编辑页面布局

- **顶部导航区**：高度64px，包含返回箭头、标题区、功能按钮
- **左侧卡片选择区**：固定宽度400px，包含流程卡和工作任务卡两个标签页
- **右侧画布区**：剩余空间，用于拖放和连接卡片

### 4.2 使用页面布局

- **用户输入区**：左侧，固定宽度600px
- **系统输出区**：右侧，占据剩余空间

### 4.3 颜色规范

- **主题色**：深蓝色 (#1A1F2C)，用于导航背景和强调
- **卡片背景**：白色 (#FFFFFF)
- **卡片边框**：浅灰色 (#D9D9D9)
- **连接线**：
  - 默认：#1890FF
  - YES线：#52C41A
  - NO线：#FF4D4F
- **状态颜色**：
  - 空闲：灰色 (#D9D9D9)
  - 运行中：蓝色 (#1890FF)
  - 等待中：黄色 (#FAAD14)
  - 完成：绿色 (#52C41A)
  - 失败：红色 (#FF4D4F)

### 4.4 交互规范

- **拖拽行为**：
  - 从左侧选择区拖动卡片到画布
  - 画布中的卡片可自由移动
  
- **连接操作**：
  - 选中卡片时显示四个连接点
  - 点击连接点并拖动可创建连接线
  - 连接线需指向目标卡片的连接点
  
- **画布交互**：
  - 按住空格键+鼠标拖动实现平移
  - 双击卡片可编辑卡片属性
  - 右键菜单提供删除、复制等操作

## 5. 卡片类型定义

### 5.1 第一阶段卡片

#### 5.1.1 起点卡

**功能**：
- 工作流入口，每个工作流必须且只能有一个
- 在使用界面显示输入框和提交按钮
- 生成全局变量：`@工作流名称.start`

**界面要素**：
- 卡片标题：起点
- 提示文本输入区
- 显示变量标识符：`@工作流名称.start`

**执行流程**：
- 用户在使用界面输入信息并提交
- 记录输入到全局变量
- 触发下游卡片执行

#### 5.1.2 工作任务卡

**功能**：
- 执行已创建的工作任务
- 将任务输入/输出注册为全局变量

**界面要素**：
- 卡片标题：工作任务名称
- 显示所用NPC和AI服务
- 显示输入/输出变量标识符

**执行流程**：
- 接收上游数据
- 执行关联的工作任务
- 更新输出变量
- 触发下游卡片

#### 5.1.3 赋值卡

**功能**：
- 在工作流执行过程中为变量赋值
- 支持多条赋值规则（最多10条）

**界面要素**：
- 卡片标题：赋值
- 赋值规则列表
- 添加/删除规则按钮

**执行流程**：
- 顺序执行所有赋值规则
- 每条规则将源变量值赋给目标变量
- 完成后触发下游卡片

#### 5.1.4 循环卡

**功能**：
- 根据条件判断流转方向
- 支持两种条件类型：运行次数和变量值判断

**界面要素**：
- 卡片标题：循环
- 条件类型选择
- 条件参数配置
- YES/NO分支标记

**执行流程**：
- 评估条件是否满足
- 满足条件走YES分支
- 不满足条件走NO分支

#### 5.1.5 展示卡

**功能**：
- 在系统输出区展示指定变量内容
- 支持直接显示或生成式显示

**界面要素**：
- 卡片标题：展示
- 变量选择器
- 显示方式选择：直接/生成式

**执行流程**：
- 获取指定变量的值
- 在系统输出区展示内容
- 完成后触发下游卡片

### 5.2 第二阶段卡片（后续开发）

#### 5.2.1 AI判断卡
- 解析文本并动态生成提问
- 在使用界面生成互动输入区

#### 5.2.2 子工作流卡
- 嵌套调用已创建的工作流
- 作为单一卡片展示，无需展开内部细节

## 6. 连接规则

### 6.1 卡片连接限制

- **起点卡**：
  - 没有流入连接
  - 不限制流出连接数量
  - 每个工作流必须有且只有一个起点卡
  
- **循环卡**：
  - 限制为两个流出分支，分别标记为YES和NO
  - 可以有多个流入连接
  
- **其他卡片**：
  - 不限制流入连接数量
  - 不限制流出连接数量
  - 当有多个流入连接时，需要等待所有上游节点完成才会触发

### 6.2 执行规则

- **触发机制**：
  - 卡片执行需要所有流入节点完成
  - 节点完成后自动触发下游节点
  
- **运行状态**：
  - 工作流节点有明确的状态：空闲、运行中、等待中、完成、失败
  - 工作流执行状态可以在UI上实时可见
  
- **后台执行**：
  - 工作流可以在用户离开页面或关闭浏览器后继续在后台执行
  - 支持执行状态的持久化存储
  
- **取消机制**：
  - 用户可以在任何时候取消正在运行的工作流
  - 取消后会标记已执行节点为完成状态，未执行节点为取消状态
