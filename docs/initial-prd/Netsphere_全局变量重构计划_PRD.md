# 重构思路

我们要重构全局变量的定义，让它能够更友好的让系统识别和处理。

我计划重构标识符的设计方式，我们用UUID作为变量的唯一主键，来构建变量标识符

例如 一个全局变量UUID为abc123

标识符的结构将变为 「@gv_abc123」，其中@gv_作为固定前缀，后面拼装UUID

但同时，我们通过一个标识符渲染组件，在有需要的页面，把@gv_abc123渲染成用户可见的，带标签样式的 @sourceName.fieldName#sourceId。对用户视觉友好，以便于分析和观察



### 被渲染的变量标识符标签

我们将这个定义为被渲染的变量标识符标签，它作为个显示样式展示出来

并按照变量定义的主色，有不同的颜色显示



#### 格式

典型格式为：@sourceName.fieldName#sourceId，然后通过html样式渲染包含在一个框中

- @sourceName 变量来源名称

- .fieldName来源类型说明

- #sourceId，注意 这个ID从6位改成4位



#### 例如

自定义变量真实的标识符@gv_abc123，样式渲染显示：@自定义变量.value#4位ID

NPC变量真实的标识符@gv_ab43c122，样式渲染显示：@NPC名称.字段#4位ID

工作流变量真实的标识符@gv_4321129，样式渲染显示：：@工作流名称.字段#4位ID



# 设计目的

这样的设计是为了保持底层数据的唯一和有效性

不论用户看到的内容是什么，实际存在的标识符是唯一不变的，不会因为全局变量中的内容变化，而导致重新处理。

被重新处理的只是渲染样式。



#### 在应用上，例如变量编辑器里

@gv_abc123 这个的变量编辑器2里作为 rawText存储

@sourceName.fieldName#sourceId实际上将是一个页面上的视觉效果，而不是存储了这样一个字段，通过「标识符渲染组件」渲染的html样式存储在变量编辑器2的 html格式里，在编辑器，插入变量，读取保存的编辑器格式的数据html格式时渲染。

渲染效率可以通过动画来弥补。给用户呈现可以接受延迟，通过动画效果来弥补。

变量编辑器2里，解析组件将迭代，解析@gv_abc123的值进行拼装实际的文本值



# 变量创建、读取、更新和删除的稳健性

变量的CRUD依赖于变量来源，每一个不同来源的变化，都会通知全局变量系统更新内容。

每一个不同类型都有不同的需要注册的变量类型，会不断扩展和调整

**系统中有五种主要变量类型（NPC、TASK、CUSTOM、FILE、WORKFLOW），每种类型的变量源和字段名如下：**

NPC 类型中文名称 NPC

TASK 类型中文名称 工作任务

CUSTOM 类型中文名称 自定义

FILE 类型中文名称 文件

WORKFLOW 类型中文名称 工作流

请你补充各类型当前的主色定义



## NPC

#### @sourceName来源

为NPC的姓名字段



#### .fieldName 包括

    name - 来自"名称"，也是名称中显示的中文

    description - 来自"描述"，，也是名称中显示的中文

    kb 改为knowledge - 来自"知识背景"（简化自knowledgeBackground），也是名称中显示的中文

    ap 改为act- 来自"行为原则"（简化自actionPrinciples），也是名称中显示的中文

    al 改为actlv- 来自"活跃度"（简化自activityLevelDescription），也是名称中显示的中文



#### #sourceId为4位ID



#### 变量标识符格式示例

@茶叶蛋.name#1557

@云透.act#1528

@张三.description#52bd

@茶叶蛋.actlv#1597

@云透.act#12bd

## TASK

#### @sourceName来源

@sourceName 来自WorkTask的name属性

示例：@问答任务（其中"问答任务"是工作任务的名称）



#### .fieldName 包括

    input - 来自尚未定义，显示名称为"输入"

    output - 来自尚未定义，显示名称为"输出"



#### #sourceId为4位ID



#### 变量标识符格式示例

@问答任务.input#ef34

@问答任务.output#ef12



### CUSTOM

自定义变量是目前唯一可以通过变量列表页面进行CRUD的变量



#### @sourceName来源

来自于自定义变量的名称字段



#### .fieldName 包括

    value - 唯一的字段，存储变量值，显示名称为「值」



#### #sourceId为4位ID



#### 变量标识符格式示例

@自定义变量.value#1557

@哈哈.value#1528



### FILE

待定



### WORKFLOW

#### @sourceName来源

来自Workflow的name属性

示例：@审批流程（其中"审批流程"是工作流的名称）



#### .fieldName 包括

    name - 来自工作流名称，显示名称为"名称"

    其他待定



#### #sourceId为4位ID



#### 变量标识符格式示例

@工作任务.name#1529



## CRUD稳健性

请参考NPC目前的注册、更新和删除机制，让变量的CRUD成为一个完整健壮的方法可以被调用。



### 创建

例如，当NPC被创建后，全局变量增加该NPC的变量，在列表显示字段包括

类型、来源、名称、系统标识符、可视化标识符、值和操作

类型用图标+文字显示，采用我们定义的分类主色，文字即NPC、工作任务、工作流、自定义、文件

来源即@sourceName来源的值，例如NPC的名称、自定义变量的名称、工作任务的名称和工作流的名称

名称即.fieldName，例如name，act，value等，参考来源字段的名称，给它一个对应的中文名称，例如名称、活跃度、描述、行为原则、知识背景等

将原表格的标识符移除，增加两个新的表字段

**系统标识符，即我们重构的真实的变量标识符 @gv_32543132143之类，直接显示文本，不带样式。**

**可视化标识符，是样式被渲染的变量标识符标签，主色依据分类主色，标签内文字为 @sourceName.fieldName#sourceId 格式**



在变量列表一定要注意稳健性的问题，不要出现孤儿变量



### 读取

**如果是在变量编辑器2内**

当在rawtext读取到**@gv_32543132143，通过变量编辑器，渲染成 @sourceName.fieldName#sourceId显示**

如果本来就读取的是html格式，则直接显示**@sourceName.fieldName#sourceId**



### 更新

当变量的值更新，**@gv_32543132143是保持变的**

**@sourceName.fieldName#sourceId 则会因为其中的@sourceName发生变化而变化，其他两个（.fieldName和#sourceId）是不变的**



### 删除

除了自定义变量，其他变量是通过变量源来通知删除的





