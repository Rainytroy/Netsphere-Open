工作流是本系统最重要也最复杂的模块，它包含两个大的部分：工作流列表，单个工作流



# 结构

## 工作流列表

用于展示所有已经创建的工作流，列表样式符合当前UI设计规范，和Netsphere其他页面保持一致。提供搜索查询和排序功能。

列表单元包括

- 工作流名称

- 工作流简介

- 编辑、删除、复制按钮，还有一个运行按钮

    - 点击编辑按钮进入工作流编辑页面

    - 点击删除则删除工作流

    - 点击复制可以将当前工作流进行复制，复制后工作流名称后增加「-副本」和原工作流区分

    - 点击运行按钮进入工作流使用界面

工作流列表可以点击创建按钮创建一个新的工作流，进入工作流编辑器页面。



## 工作流创建/编辑

工作流创建页面是一个工作流编辑器，这个页面包含两个可切换的标签：

**编辑：**工作流编辑界面，设计者在这个界面对工作流进行编辑和管理，这是首先呈现给用户的界面，创建时也会先进入此界面。

**使用：**工作流使用界面，工作流创建完成后，用户可以在使用界面运行工作流，同时工作流运行时需要的输出，和必要的输出都会在这个界面呈现。

编辑页面和使用页面相互关联。



工作流的创建和编辑是这个模块最核心的功能，也是最复杂的功能，接下来会做详细的说明。



**工作流模块结构**

-工作流列表

-工作流创建/编辑

-创建

-卡片选择区

-画布

-使用

-用户输入区

-系统输出区



# 创建/编辑

创建和编辑工作流时，会进入工作流编辑界面。

为了给用户提供足够的空间来进行复杂的工作流编辑，进入编辑页面自动折叠左侧导航栏（这个功能目前已经具备）。



## 1、顶部标题导航区域

我们现在描述编辑区的内部页面布局：

编辑区大部分内容是一个可拖动的画布，在顶部和其他页面的创建，编辑样式保持一致，有一个返回箭头，文本描述为创建。

但是需要在这一行 创建后 增加一个工作流名称的输入框，加一个 [编辑名称按钮]。

- 在工作流编辑页面，点击左侧返回箭头，点击时二次确认弹窗，提示用户「确认退出工作流编辑器吗？请记得保存」，用户点击取消按钮不返回，保持现状，用户点击确定直接返回。

- 创建工作流时，默认将工作流起名为"未命名工作流"，系统内的工作流可以重名，在工作流名称后有一个编辑图标，即 [编辑名称按钮]，点击可以编辑工作流名称并保存。

右侧右对齐有三个功能按钮

- 一个使用按钮，点击后切换到使用界面

- 一个保存按钮，点击后立刻保存工作流编辑器当前的编辑状态。

- 另外一个是退出按钮，点击后退出这个页面，返回工作流列表，点击时二次确认弹窗，提示用户「确认退出工作流编辑器吗？请记得保存」，用户点击取消按钮不返回，保持现状，用户点击确定直接返回。



## 2、主编辑区域

主编辑区域左右分为两部分：卡片选择区和画布



### 卡片选择区

左侧400px，罗列供用户可选择加入工作流的「卡片」，这个部分有两个可切换的标签，一个是流程卡，一个是工作任务卡。



#### 流程卡

流程卡是编辑器提供的各种各样的卡片，用来和工作任务卡相互连接来让工作流按用户的需求运行，我会在后续章节仔细定义第一版本会出现的卡片和规则。

例如，第一张流程卡是「起点卡」，这张卡在一个工作流中必须存在，供用户使用的工作流都要从起点卡开始，起点卡会在使用页面生成一个带提示文本的输入框，要求用户输入文本，并点击提交。提交动作会以各种各样的条件出发起点卡后连接的工作任务卡片或者其他流程卡运行。

注意，起点卡的提示文本，会成为工作流列表内，工作流卡片的描述文本



#### 工作任务卡

工作任务卡是在工作任务创建的所有卡片，即工作任务卡片列表。这些卡片也可以被拖动到编辑区。和工作卡片或者流程卡连接在一起。形成任务流。



### 画布

右侧剩余空间为卡片画布，支持拖拽卡片到这个区域，并且用连接线连接到形成工作流。

用户从卡片选择区，可以用鼠标选择一张卡片，拖动一个卡片实例到画布区进行编辑。卡片选择区的对应卡片，会有一个数字显示该卡片已在编辑区使用了几次。

拖动到卡片画布之后，这个卡片右上角会有一个删除按钮，可以从画布移除。

画布里的卡片是一个卡片实例，当卡片被选中时，卡片有一个焦点边框，并且在边框四边各有一个连接点。

用户可以选择一个连接点，长按鼠标左键拖出一条连接线，指向下一个卡片。

当光标进入下一张卡片所在区域，第二张卡片会出现四个连接点，用户释放鼠标后就近连接，产生一个有箭头指向的连接线。

注意：我更希望现在有开源的封装好的组件方案来实现这个功能，只要能达成工作流的编辑管理效果即可。请在分析需求时给我提供建议。



每一个卡片都具备以下特性。

- **流入线：**流入线的另一端的卡片，可以是流程卡，也可以是工作任务卡，只有起点卡没有流入线，因为它是第一张卡片。

- **触发：**当上一张卡片完成了一次运行，就会按时序触发下一张卡片。但如果一张卡片有多条流入线的时候，就需要满足所有上游卡片都完成运行，才会触发卡片。

- **运行：**卡片执行一次卡片内的任务（例如工作任务的运行）或者规则。

- **完成：**卡片完成任务后，有一个完成状态（例如工作任务卡片中输出的内容更新了，AI运行并产生了一次output），完成状态会被计数，因为卡片可以会重复运行多次。

- **流出线：**完成状态通过流出线去触发下一个卡片。



## 3、卡片定义

现在我们对卡片进行详细的定义，我们现在列出第一阶段所需要的卡片，以完成整个项目的初始搭建，我们也会列出第二阶段所需的卡片，这些卡片更复杂，需要更多的仔细设计。列出这些需求是为了让你能够周密的考虑卡片的可扩展性和抽象度。



### 第一阶段

#### 工作任务卡片

工作任务卡片是用户在在工作任务模块创建的所有卡片，罗列在工作流编辑区的卡片选择列表供用户使用。

除工作任务卡片外，下述其他类型卡片，都输入流程卡，在选择区归属流程卡选单内。

|类型|工作任务卡|
|-|-|
|卡片必须显示的信息|工作任务名称
列出调用的NPC
列出调用的AI
展示输入变量标识符
展示输出变量标识符|
|触发|上一张卡片的完成状态通过流入线进入到此卡牌，触发执行。如果此卡片被连接了多个流入线，那就需要等待多张前置卡片都完成才会触发|
|完成状态定义|工作任务由input输入框和NPC的模板组装成prompt，交给对应Ai运行，并产生最新的output输出，视为完成|
|流出|一条流出线|



接下来我们会介绍流程卡。

**我们需要增加一种新的全局变量类型：流程卡，用来记录各种流程卡会产生的全局变量，有的卡片会具备这个能力。**



#### 起点卡

起点卡是一个工作流必须的卡片，是工作流的起点。所以这张卡在卡片编辑区默认出现。



**功能**

在使用区的用户输入部分向用户呈现一个带有提示文本的输入框，这是用户在使用工作流时首先会做的事

用户填写内容并提交，工作流会开始流转。

起点卡会产生一个新的全局变量，用来记录用户输入信息，可以供之后的流程中使用。



**全局变量格式**

|类型|来源|名称|标识符|值|操作|
|-|-|-|-|-|-|
|流程卡|起点卡|工作流名称|`@工作流名称.start`|文本：例如 我要设计一个产品|在全局变量列表不可编辑|

**界面要求**

|类型|起点卡|
|-|-|
|卡片必须显示的信息|卡片类型
提示文本输入区：长文本输入框
提示文本输入区：保存按钮
展示起点卡全局变量标识符|
|触发|用户在「使用」界面输入信息|
|完成状态定义|工作任务由input输入框和NPC的模板组装成prompt，交给对应Ai运行，并产生最新的output输出，视为完成|



#### 赋值卡

**功能**

赋值卡的作用是，当工作流转到这个卡片节点的时候，对系统中的全局变量进行赋值操作，以便于传递数据。

赋值卡显示一个赋值操作界面，显示一行赋值规则编辑功能：第一个全局变量选择器，点击下拉后可以搜索和选择一个全局变量。之后是 = 等号符号，后面在接第二个全局变量选择器。用户来告知用户，可把左侧全局变量赋值到右侧全局变量。即赋值规则是「复制选择器」赋值到「复制选择器」

被拖入到画布的赋值卡，默认出现一条赋值规则，可删除，可拖动，但是用户可以在卡片内新增一行，一张卡片最多可以赋值10个变量。

用户完成规则设置后，卡片在运行时按照排列顺序从上到下进行赋值操作。



**界面要求**

|类型|起点卡|
|-|-|
|卡片必须显示的信息|卡片类型
赋值规则「复制选择器」赋值到「复制选择器」
新增赋值规则按钮|
|触发|上游卡片均完成并流出到本卡片|
|完成状态定义|罗列规则从上到下完成赋值|



#### 循环卡

**功能**

循环卡用来判断卡片的流向，循环卡会有最多两个流出分支，Yes线和No线，循环卡会设定一个条件判断，满足条件，走Yes线，不满足条件走No线。

卡片内设置条件可以扩展，当前预设的条件为两种，供用户进行选择

在下拉菜单选择类型，不同类型有不同的规则设置方式



**1、运行次数**

上一张卡牌在这个工作流的运行次数，通过计数来判断流向：例如：卡片已运行3次 则为 Yes

**2、变量判断**

在当前全局变量环境中，判断变量 值 =「用户指定的文本内容」，则为 Yes



**界面要求**

|类型|起点卡|
|-|-|
|卡片必须显示的信息|卡片类型
类型选择框
对应类型的规则配置
1、上游卡片运行次数，Yes或者No的指向
2、全局变量值 = 用户输入文本，Yes或者No的指向|
|触发|上游卡片均完成并流出到本卡片|
|完成状态定义|规则从判断完毕|
|流出|限制两条流出线，线条样式不同区分|



#### 展示卡

**功能**

展示卡的作用是在任务流转到此处时，把指定变量的内容展示到使用区的系统输出部分。全局变量以文本形式展示在使用区，用逐个文字逐个文字的效果渲染显示，模拟一个AI正在生成内容的过程。

在使用区的系统输出内容界面里，每一个展示卡显示一个块内的文本，展示区支持markdown语法，显示排版清晰的文字内容。这个块顶部有一个导出按钮，可以以md格式和pdf格式导出块内内容。

在工作流中如果使用了多张展示卡，就在使用区的系统输出内容部分，按顺序展示并呈现，上一个卡片的文本生成还没结束，不启动下一个部分的展示。

直到展示完毕。



**界面要求**

|类型|起点卡|
|-|-|
|卡片必须显示的信息|卡片类型
选择指定要展示的全局变量
可以切换按钮，让用户选择，呈现在使用区的内容，是直接整段文本展示，还是用一个生成式逐字逐句出现的效果。|
|触发|上游卡片均完成并流出到本卡片|
|完成状态定义|使用区系统输出部分开始显示文本|



### 第二阶段（理解需求，但放低开发优先级）

#### AI判断卡

**功能**

解析指定全局变量里的文本内容，如果该文本内容在语义判断上有向用户提问的需求，则动态的在使用区的用户输入部分，动态展示多个输入框。输入框的结构包含提问和输入框两部分，多个问题则自上而下罗列，然后有一个提交按钮。



**界面要求**

|类型|起点卡|
|-|-|
|卡片必须显示的信息|卡片类型
选择指定要解析的全局变量
指定负责解析的AI服务（由Netsphere的AI服务模块提供列表）
提问数量|
|触发|上游卡片均完成并流出到本卡片|
|完成状态定义|使用区用户输入部分，增加显示动态生成的提问框|



在第二阶段，我们还会生成更多的调用AI服务，动态的在用户使用区的输入和输出部分生成组件的卡片。请注意这种类型的扩展。

同样，我们也会有更多的流程卡片



# 使用

在卡片功能的阐述中，我们已经看到有一些卡片会和使用区发生交互。



使用区分为左右两部分，这个界面在当前UI框架中，保留统一一致的顶部LOGO和左侧导航，左侧导航依然自动折叠，以给使用区留出足够的页面空间

在以上框架下，左侧是统一样式的 左侧箭头 使用：工作流名称

- 在工作流使用页面，点击左侧返回箭头，点击时二次确认弹窗，提示用户「确认退出工作流使用界面吗？请记得保存」，用户点击取消按钮不返回，保持现状，用户点击确定直接返回。

- 只有在编辑界面，才会对工作流名称进行编辑，使用界面无编辑功能

右侧右对齐有三个功能按钮

- 一个编辑按钮，点击后切换到编辑界面

- 一个保存按钮，点击后立刻保存工作流编辑器当前的编辑状态。

- 另外一个是退出按钮，点击后退出这个页面，返回工作流列表，点击时二次确认弹窗，提示用户「确认退出工作流使用界面吗？请记得保存」，用户点击取消按钮不返回，保持现状，用户点击确定直接返回。



-用户输入区

-系统输出区

UI宽度自适应，固定宽度用户输入区，系统输出区自适应，因为输出区的文本内容是最多的，输入区的文本内容较少，所以宽度可以小一些，我在考虑600px。你可以给我提供一个合理值。



## 用户输入区

用户输入区会默认显示一个输入框和提交按钮，这是起点卡在编辑区被配置后，在这个页面对应需要获得的内容，以触发工作流。

提交按钮点击后，禁用提交按钮避免反复提交工作流，在卡片下方显示一个动画效果提示用户正在生成中，显示一个停止按钮，中断工作流的生成。中断后，中断按钮消失，工作流停止运行，提交按钮重新启用。

如果用户再次点击运行按钮，需要弹窗二次提示用户，提交后工作流会开始运行，已输出内容会清空。用户确认后清空。

这里还可以显示其他卡片在工作流中需要显示的输入信息，从上到下依次显示即可。超过页面高度可以滚动。



## 系统输出区

这里显示例如使用显示卡后，向用户展示的结果。根据卡牌的设置，这里会直接显示或者生成式显示，这里的显示区域需要显示markdown格式，并向用户提供从页面导出md和pdf格式文档的能力。

当内容超过高度后自动向下滚动，用户可以滚动页面来回查看。

在没有内容生成式提示用户，尚未开始产出。

在工作流运行期间，可能会花费一些时间，因为工作任务卡片的运行依赖于AI返回信息，所以用户可以点击终端正在运行的工作流。

此时系统输出区暂停输出，已显示信息保留。

用户再次运行工作流时清空。



