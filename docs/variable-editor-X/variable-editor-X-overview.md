# 变量编辑器VariableEditorX概述与需求

**版本**: 1.1.0  
**创建日期**: 2025年3月23日  
**更新日期**: 2025年3月24日  
**文档状态**: 已实现  

## 1. 背景

Netsphere平台已完成全局变量系统的重构，采用了基于UUID的变量标识符机制，提高了变量引用的稳定性和可靠性。全局变量系统允许各个功能模块（如NPC、工作任务、工作流等）将其内部数据作为变量开放给系统中的其他模块使用。

目前平台存在两个旧版变量编辑器：
- VariableEditor（旧版）
- VariableEditor2（旧版）

由于之前的迭代导致了一些混乱，需要摒弃之前的设计思路，完全重新重构变量编辑器VariableEditorX，以更好地支持基于UUID的变量标识符系统。

## 2. 目标

1. **全新设计**: 在`/demo/variable-editor-x`路径创建全新的变量编辑器，完全摒弃旧版设计思路
2. **完整支持UUID标识符**: 无缝支持`@gv_UUID_field`格式的系统标识符
3. **优化用户体验**: 提供直观的变量选择和插入体验
4. **建立测试环境**: 开发演示界面进行编辑器的调整和测试
5. **架构优化**: 设计清晰的组件架构，便于复用和维护
6. **确保稳定性**: 在各种使用场景下保持稳定和一致的行为

## 3. 范围

### 3.1 基本功能需求

1. **文本编辑**
   - 富文本编辑基础功能
   - 变量标签的插入、显示和删除
   - 支持只读模式

2. **变量选择**
   - 输入@触发变量选择
   - 工具栏按钮触发变量选择
   - 变量搜索和过滤

3. **内容格式**
   - HTML格式（带标签样式）
   - 系统标识符格式（rawtext）
   - 解析格式（变量值）

4. **工具栏功能**
   - 变量插入按钮
   - 显示解析值按钮
   - 版本号显示

5. **测试功能**
   - 展示不同格式的内容
   - 存储和重置功能
   - 调试信息显示

### 3.2 核心场景

1. **编辑场景**
   - 用户从零开始创建文本并插入变量
   - 用户编辑已有文本中的变量
   - 用户复制粘贴包含变量的文本

2. **展示场景**
   - 将变量标识符解析为实际值
   - 只读模式下展示变量标签

3. **导入/导出场景**
   - 导入rawtext格式并转换为HTML格式
   - 导出HTML格式为rawtext格式

### 3.3 不包含在范围内

1. 复杂的富文本编辑功能（如表格、图片等）
2. 变量的创建和管理功能
3. 与特定业务逻辑的深度集成

## 4. 关键需求详解

### 4.1 变量标识符支持

变量标识符分为两种格式：

1. **系统标识符**
   - 格式：`@gv_UUID_field`
   - 作用：用于系统内部存储和引用，确保稳定性
   - 特点：基于UUID，不受变量源名称变更影响

2. **显示标识符**
   - 格式：`@sourceName.field#shortId`
   - 作用：在编辑器中显示，提供用户友好的体验
   - 特点：包含来源名称，便于用户识别

编辑器需要支持这两种格式的无缝转换，在界面上显示友好的标识符，而在存储时使用系统标识符。

### 4.2 内容格式设计

编辑器需要处理三种不同的内容格式：

1. **HTML格式**
   - 包含变量标签的样式和属性
   - 用于编辑器内部展示和编辑
   - 示例：
     ```html
     <p>我是<span data-variable="" data-id="f9c17d21-a0a0-476f-973e-433e08f7be38" data-field="actlv" data-identifier="@gv_f9c17d21-a0a0-476f-973e-433e08f7be38_actlv" data-type="npc" class="variable-tag variable-type-npc" contenteditable="false">@云透.actlv#f9c1</span></p>
     ```

2. **系统标识符格式（rawtext）**
   - 只包含纯文本和系统标识符
   - 用于数据存储和传递
   - 示例：
     ```
     我是@gv_f9c17d21-a0a0-476f-973e-433e08f7be38_actlv
     ```

3. **解析格式**
   - 变量标识符被替换为实际值
   - 用于最终展示
   - 示例：
     ```
     我是有趣的事情就可以驱动我
     ```

### 4.3 变量选择与插入

当用户需要插入变量时，编辑器应提供直观的选择机制：

1. **触发方式**
   - 输入@字符自动触发
   - 点击工具栏"插入变量"按钮

2. **选择界面**
   - 在光标位置下方显示变量列表
   - 支持按显示标识符搜索过滤
   - 显示变量来源和类型信息

3. **插入效果**
   - 选择后在光标位置插入变量标签
   - 标签使用对应变量类型的颜色和样式
   - 标签显示友好的标识符，但存储系统标识符

### 4.4 测试面板需求

演示界面应包含测试面板，以便开发和验证：

1. **内容格式展示**
   - 显示HTML格式
   - 显示JSON格式
   - 显示rawText格式
   - 显示解析格式

2. **操作按钮**
   - 保存内容（存储到本地存储）
   - 重置文本框内容为空

3. **调试信息**
   - 显示编辑器状态
   - 显示已使用的变量列表
   - 日志输出

## 5. 与现有系统的关系

### 5.1 全局变量系统集成

编辑器需要与全局变量系统紧密集成：
- 遵循变量标识符规范
- 使用变量服务获取变量数据
- 支持变量解析和转换

### 5.2 演示环境

新编辑器将首先在`/demo/variable-editor-x`路径实现，作为独立演示和测试环境。开发完成后，该编辑器将作为组件复用到Netsphere平台中其他需要变量编辑功能的地方。

### 5.3 向后兼容性

虽然是全新重构，但新编辑器需要：
- 支持导入旧格式的内容
- 确保导出的内容可被现有系统解析
- 与现有变量显示标准保持一致性

## 6. 性能和质量要求

1. **响应性**
   - 编辑操作应无明显延迟
   - 变量选择应迅速响应

2. **稳定性**
   - 大量变量存在时应保持稳定
   - 边缘情况处理（如变量不存在）

3. **扩展性**
   - 代码结构清晰，便于维护和扩展
   - 组件化设计，支持复用

4. **兼容性**
   - 支持常见浏览器
   - 适应不同屏幕尺寸

## 7. 版本1.1更新内容

### 7.1 HTML渲染问题修复

在1.0版本中，变量标签在HTML渲染时存在以下问题：
- 变量标签的属性值（id、field等）被错误替换为默认值
- 变量标签显示为`@Unknown.unknown#xxx`而非正确标识符
- 样式颜色错误，不能正确应用变量类型对应的颜色

1.1版本完全重写了变量标签的渲染逻辑，确保：
- 属性值正确保存和传递
- 变量标签显示正确的标识符
- 根据变量类型应用正确的样式

### 7.2 架构优化

1.1版本引入了更清晰的架构分层：
- 引入Manager模式，专门处理特定功能域
- 拆分大型组件为职责明确的小组件
- 优化状态管理和数据流

### 7.3 UI改进

- 统一编辑器焦点和悬停状态的样式
- 确保变量标签在各种状态下的正确显示
- 优化工具栏布局和交互体验
