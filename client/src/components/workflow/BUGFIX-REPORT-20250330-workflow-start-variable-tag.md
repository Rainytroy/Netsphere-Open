# 工作流起点卡变量标签丢失问题修复报告

## 问题描述

在使用工作流起点卡编辑器时，当保存带有变量标签的内容后，再次打开编辑器时变量标签会丢失，显示为纯文本。但工作流卡片和描述中能正确显示解析后的变量值。

## 原因分析

问题出在`StartNodeConfig.tsx`组件的保存逻辑中。在保存时，代码获取了编辑器内容后立即进行了变量解析，并将解析后的内容保存到以下三个地方：

1. NodeConfig的`promptText`属性 - 这个是决定编辑器重新打开时显示内容的关键
2. 工作流对象的`description`属性 
3. 工作流全局变量的`description`变量

初步分析时认为仅仅使用原始文本代替解析后的文本就能解决问题，但经过测试发现这是不够的。

**关键错误**：
1. 解析后的内容（已替换变量标签为实际值）被保存到了`promptText`
2. 即使保存原始`rawText`也不包含完整的变量标签结构信息

```typescript
// 原有代码
const config = {
  ...initialConfig,
  promptText: finalPromptText // 使用解析后的内容，变量标签已被替换
};
```

## 解决方案

修改保存逻辑，区分三个保存目标的内容格式：

1. **NodeConfig的`promptText`** - 使用`richContent.html`，这包含了完整的变量标签DOM结构
2. **工作流`description`** - 继续使用解析后的`parsedContent`，显示实际值
3. **工作流变量`description`** - 继续使用解析后的`parsedContent`，显示实际值

```typescript
// 修改后代码
const config = {
  ...initialConfig,
  promptText: richContent.html // 保存HTML内容，包含完整的变量标签结构
};
```

## 设计考虑

这个修改遵循了不同场景的内容需求：
- 编辑器需要完整的HTML内容（包含变量标签的DOM结构）
- 展示界面需要解析后内容（显示变量实际值）

我们发现变量标签的正确展示依赖于完整的HTML结构，而不仅仅是原始文本中的标识符。HTML内容包含了所有必要的DOM属性，如`data-variable-id`等，这些是变量标签正确渲染所必需的。

## 测试案例

1. 在起点卡添加变量标签（如@系统.当前时间）
2. 保存配置
3. 关闭并重新打开起点卡编辑器
4. 验证变量标签是否正确显示而非显示解析后的值

## 相关文件

- `StartNodeConfig.tsx` - 工作流起点卡配置组件

## 后续优化

考虑在更多组件中统一使用这种模式：原始内容用于编辑，解析内容用于展示。
